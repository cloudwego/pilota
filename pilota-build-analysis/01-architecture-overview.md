# Pilota-Build 架构分析与重构建议

## 1. 当前架构分析

### 1.1 总体架构评估

从编译器设计的角度看，pilota-build 采用了经典的多阶段编译架构：

```
源文件 → 解析 → IR → 符号解析 → RIR → 类型检查 → 代码生成
```

**优点：**
- 清晰的分层设计，每层职责明确
- 使用 Salsa 框架实现增量编译，性能优化良好
- 统一的 IR 表示，支持多种 IDL（Thrift/Protobuf）
- 插件机制提供了一定的扩展性

**问题：**
1. **阶段耦合**：符号解析、类型检查和代码生成阶段存在较强耦合
2. **IR 设计不够抽象**：当前 IR 仍保留了太多源语言特性
3. **类型系统分散**：类型定义分散在多个模块中（ty, rir, codegen）
4. **错误处理不系统**：缺乏统一的错误收集和报告机制
5. **插件能力受限**：插件只能在特定点介入，无法深度定制编译流程

### 1.2 核心组件分析

#### 1.2.1 数据库层（Salsa）
```rust
pub struct RootDatabase {
    storage: salsa::Storage<Self>,
    nodes: Arc<FxHashMap<DefId, rir::Node>>,
    files: Arc<FxHashMap<FileId, Arc<rir::File>>>,
    // ...
}
```

**优点**：
- 使用 Salsa 实现查询缓存，支持增量编译
- 数据不可变，线程安全

**问题**：
- 查询粒度过粗，可以进一步细化
- 缺少依赖追踪的可视化支持

#### 1.2.2 中间表示（IR）
当前有三层表示：
1. **IR**：直接从 AST 转换的初始表示
2. **RIR**（Resolved IR）：符号解析后的表示
3. **CodegenTy**：代码生成使用的类型

**问题**：
- 层次过多，转换开销大
- 每层之间的差异不够明显
- 缺少统一的 AST 遍历框架

#### 1.2.3 类型系统
```rust
pub enum TyKind {
    String, Void, U8, Bool, Bytes,
    Vec(Arc<Ty>), Map(Arc<Ty>, Arc<Ty>),
    Path(Path), // 未解析的类型引用
    // ...
}
```

**问题**：
- 类型表示过于简单，缺少泛型支持
- 类型推导能力有限
- 缺少类型约束系统

### 1.3 编译流程分析

当前编译流程：
1. **解析阶段**：各自的 Parser 实现，产生统一 IR
2. **符号解析**：Resolver 遍历 IR，构建符号表
3. **类型检查**：在 Context 构建时进行
4. **代码生成**：Backend 遍历 RIR 生成代码

**问题**：
- 缺少独立的语义分析阶段
- 类型检查和代码生成耦合过紧
- 没有中间代码优化阶段

## 2. 重构方向

### 2.1 架构重构目标

1. **更清晰的阶段分离**：每个编译阶段独立，通过明确的接口通信
2. **更强大的类型系统**：支持泛型、类型推导、约束求解
3. **更灵活的插件机制**：允许插件介入任何编译阶段
4. **更好的错误处理**：统一的诊断系统，支持错误恢复
5. **更优的性能**：细粒度增量编译，并行化优化

### 2.2 建议的新架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Parser    │ --> │     HIR     │ --> │   Resolver  │
└─────────────┘     └─────────────┘     └─────────────┘
                           |                     |
                           v                     v
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Analyzer   │ <-- │     MIR     │ <-- │  TypeCheck  │
└─────────────┘     └─────────────┘     └─────────────┘
       |                   |                     
       v                   v                     
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Optimizer  │ --> │     LIR     │ --> │   Codegen   │
└─────────────┘     └─────────────┘     └─────────────┘
```

其中：
- **HIR**（High-level IR）：接近源语言的表示
- **MIR**（Mid-level IR）：类型检查后的表示，适合分析和优化
- **LIR**（Low-level IR）：接近目标代码的表示

### 2.3 关键改进点

1. **统一的 AST/IR 框架**：使用 Visitor 模式和代码生成
2. **模块化的类型系统**：独立的类型定义、推导和检查模块
3. **诊断子系统**：收集和报告错误、警告
4. **查询系统优化**：更细粒度的 Salsa 查询
5. **并行编译支持**：文件级和函数级并行

## 3. 实施路线图

### Phase 1：基础重构（1-2个月）
- 统一错误处理机制
- 重构类型系统为独立模块
- 引入诊断子系统

### Phase 2：IR 重构（2-3个月）
- 设计新的 HIR/MIR/LIR 体系
- 实现 AST 遍历框架
- 重构符号解析和类型检查

### Phase 3：优化和扩展（1-2个月）
- 实现细粒度增量编译
- 增强插件系统
- 添加中间代码优化

### Phase 4：性能调优（1个月）
- 并行化关键路径
- 优化内存使用
- 添加编译性能分析工具